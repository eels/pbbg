{
  servers :443 {
    protocol {
      experimental_http3
    }
  }
}

{$APP_SERVER_DOMAIN} {
  log {
    output file /var/log/server.log
    format single_field common_log
  }

  header -Server

  header Access-Control-Allow-Headers "*"

  header Access-Control-Allow-Methods "*"

  header Access-Control-Allow-Origin "https://{$APP_WEB_CLIENT_DOMAIN}"

  header Content-Security-Policy "default-src 'self'"

  header Permissions-Policy "interest-cohort=()"

  header Referrer-Policy "no-referrer-when-downgrade"

  header Strict-Transport-Security "max-age=31536000; includeSubDomains"

  header X-Content-Type-Options "nosniff"

  header X-Frame-Options "DENY"

  header X-XSS-Protection "1; mode=block"

  encode zstd gzip

  reverse_proxy node:{$NODE_PORT}
}

www.{$APP_WEB_CLIENT_DOMAIN} {
  redir https://{$APP_WEB_CLIENT_DOMAIN}{uri} permanent
}

{$APP_WEB_CLIENT_DOMAIN} {
  root * /home/web-client/build

  log {
    output file /var/log/client.log
    format single_field common_log
  }

  @StaticAssetFiles {
    file

    path *.css *.gif *.jpeg *.jpg *.js *.json *.png *.svg *.webp *.woff *.woff2
  }

  header -Server

  header Cache-Control "private, max-age=31536000, no-cache"

  header @StaticAssetFiles Cache-Control "public, max-age=31536000, must-revalidate"

  header Content-Security-Policy "default-src 'self' 'unsafe-inline' {$APP_SERVER_DOMAIN}"

  header Permissions-Policy "interest-cohort=()"

  header Referrer-Policy "no-referrer-when-downgrade"

  header Strict-Transport-Security "max-age=31536000; includeSubDomains"

  header X-Content-Type-Options "nosniff"

  header X-Frame-Options "DENY"

  header X-XSS-Protection "1; mode=block"

  try_files {path}.html {path}

  encode zstd gzip

  push

  file_server {
    precompressed br gzip
  }

  handle_errors {
    rewrite * /{http.error.status_code}.html

    file_server {
      precompressed br gzip
    }
  }
}

localhost:80 {
  reverse_proxy node:{$NODE_PORT}
}
